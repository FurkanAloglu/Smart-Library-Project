<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kütüphane - Kitaplar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen">

    <main class="container mx-auto px-6 py-8 animate-fade-in">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Kitap Arşivi</h2>
            <button id="addBookBtn" class="hidden bg-blue-600 text-white px-6 py-3 rounded-xl shadow-lg hover:bg-blue-700 transition flex items-center gap-2">
                <i class="fa-solid fa-plus"></i> Yeni Kitap
            </button>
        </div>

        <div id="tableCard" class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden hidden">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-gray-500 text-xs uppercase border-b">
                    <tr>
                        <th class="px-6 py-4">Kitap</th>
                        <th class="px-6 py-4">Yazar</th>
                        <th class="px-6 py-4">Kategori</th>
                        <th class="px-6 py-4 text-center">Stok</th>
                        <th class="px-6 py-4 text-right">İşlem</th>
                    </tr>
                </thead>
                <tbody id="bookListBody" class="divide-y divide-gray-100 text-sm"></tbody>
            </table>
        </div>

        <div id="loading" class="text-center py-20 text-gray-500">Yükleniyor...</div>
        <div id="emptyMessage" class="hidden text-center py-20 text-gray-500">Kitap bulunamadı.</div>
    </main>

    <div id="addBookModal" class="hidden">...</div> <script type="module">
        import { loadNavbar, showToast } from './assets/js/layout.js';
        import { getAllBooks, deleteBook, createBook, getAuthors, getCategories } from './assets/js/book.js';
        import { borrowBook } from './assets/js/borrowing.js'; // YENİ

        let currentUser = null;

        async function init() {
            // Navbar'ı yükle ve user bilgisini al
            currentUser = await loadNavbar();
            
            if (currentUser.role === 'ADMIN') {
                document.getElementById('addBookBtn').classList.remove('hidden');
                // Modal event listener'larını burada tanımla...
            }

            await renderBooks();
        }

        async function renderBooks() {
            const tbody = document.getElementById('bookListBody');
            tbody.innerHTML = '';
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('tableCard').classList.remove('hidden');

            const books = await getAllBooks();
            
            books.forEach(book => {
                const row = `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 font-medium">${book.title}</td>
                        <td class="px-6 py-4 text-gray-600">${book.authors?.map(a=>a.name).join(', ')}</td>
                        <td class="px-6 py-4"><span class="bg-gray-100 px-2 py-1 rounded text-xs">${book.categories?.map(c=>c.name).join(' ')}</span></td>
                        <td class="px-6 py-4 text-center">
                            <span class="${book.stock > 0 ? 'text-green-600' : 'text-red-600 font-bold'}">${book.stock}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            ${currentUser.role === 'ADMIN' ? `
                                <button onclick="window.handleDelete('${book.id}')" class="text-red-500 hover:text-red-700">Sil</button>
                            ` : `
                                <button onclick="window.handleBorrow('${book.id}')" 
                                    class="${book.stock > 0 ? 'text-blue-600 hover:text-blue-800' : 'text-gray-400 cursor-not-allowed'} font-medium" 
                                    ${book.stock <= 0 ? 'disabled' : ''}>
                                    ${book.stock > 0 ? 'Ödünç Al' : 'Tükendi'}
                                </button>
                            `}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Global Fonksiyonlar
        window.handleDelete = async (id) => { if(await deleteBook(id)) renderBooks(); };
        
        // YENİ: Ödünç Alma Global Fonksiyonu
        window.handleBorrow = async (id) => { 
            if(await borrowBook(id)) renderBooks(); 
        };

        init();
    </script>
</body>
</html>