<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKYS | Yönetim Paneli</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/100/2563eb/library.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { corePlugins: { preflight: false } };
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-up { animation: fadeUp 0.4s ease-out forwards; }
        .modal-backdrop, .modal-panel { transition: all 0.3s ease-out; }
        .dropdown-item { transition: background-color 0.2s; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">

    <main class="container mx-auto px-6 py-8 animate-fade-up">
        
      <div id="adminButtonParams" class="hidden flex flex-wrap gap-3 items-center">
    <button id="addAuthorBtn" class="h-12 bg-white text-slate-600 px-5 rounded-xl hover:bg-white hover:text-blue-600 hover:shadow-md hover:-translate-y-0.5 transition-all duration-300 flex items-center gap-2 font-bold shadow-sm text-sm">
        <i class="fa-solid fa-feather-pointed"></i> <span>Yazar Ekle</span>
    </button>
    
    <button id="addCategoryBtn" class="h-12 bg-white text-slate-600 px-5 rounded-xl hover:bg-white hover:text-blue-600 hover:shadow-md hover:-translate-y-0.5 transition-all duration-300 flex items-center gap-2 font-bold shadow-sm text-sm">
        <i class="fa-solid fa-tags"></i> <span>Kategori Ekle</span>
    </button>
    
    <button id="addBookBtn" class="h-12 bg-blue-600 text-white px-6 rounded-xl shadow-lg shadow-blue-200 hover:bg-blue-700 hover:shadow-blue-300 transition-all duration-300 flex items-center gap-2 text-sm font-bold transform active:scale-95">
        <i class="fa-solid fa-plus"></i> <span>Kitap Ekle</span>
    </button>
</div>

<div class="mb-6 relative w-full">
    <i class="fa-solid fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
    <input type="text" id="globalSearch" 
        placeholder="Kitap adı, yazar veya ISBN ile arama yapın..." 
        class="h-12 w-full pl-12 pr-4 rounded-xl shadow-sm focus:shadow-md outline-none transition-all bg-white text-slate-600 placeholder:text-slate-400">
</div>

        <div id="bookGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden"></div>
        <div id="pagination" class="flex justify-center items-center gap-2 mt-12 mb-8 hidden"></div>

        <div id="loading" class="text-center py-20 text-slate-400 flex flex-col items-center">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i> Veriler yükleniyor...
        </div>
        <div id="emptyMessage" class="hidden text-center py-20 text-slate-500">Sistemde henüz kayıtlı kitap bulunmamaktadır.</div>
    </main>

    <div id="addBookModal" class="fixed inset-0 z-50 hidden">
        
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm opacity-0 modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl transform scale-95 opacity-0 flex flex-col md:flex-row overflow-hidden max-h-[90vh] modal-panel">
                
                <div class="hidden md:flex w-1/3 bg-slate-100 items-center justify-center p-6 border-r border-slate-200 relative">
                    <div id="coverPreview" class="text-slate-400 text-center">
                        <i class="fa-solid fa-book-open text-5xl mb-3"></i>
                        <p class="text-sm">ISBN girince kapak burada görünecek</p>
                    </div>
                    <img id="coverImage" src="" class="hidden shadow-lg rounded-lg max-h-64 object-cover w-auto animate-fade-up">
                </div>

                <div class="w-full md:w-2/3 flex flex-col">
                    <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                        <h3 class="text-xl font-bold text-slate-800">Yeni Kitap Kaydı</h3>
                        <button class="closeModalBtn text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                    </div>

                    <div class="p-8 overflow-y-auto custom-scrollbar flex-grow">
                        <form id="addBookForm" class="space-y-5">
                            <input type="hidden" name="imageUrl" id="imageUrlInput">
                            
                            <div class="relative">
                                <label class="block text-sm font-medium text-slate-700 mb-1">ISBN Numarası</label>
                                <div class="flex gap-2">
                                    <input type="text" name="isbn" id="isbnInput" required placeholder="978..." class="flex-grow px-4 py-2.5 rounded-xl border border-slate-200 focus:border-blue-500 outline-none">
                                    <button type="button" id="fetchCoverBtn" class="bg-blue-50 text-blue-600 px-4 rounded-xl hover:bg-blue-100 transition text-sm font-bold">Otomatik Doldur</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Kitap Adı</label>
                                <input type="text" name="title" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-blue-500 outline-none">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-slate-700 mb-1">Stok Adedi</label><input type="number" name="stock" value="1" min="1" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 outline-none"></div>
                            </div>

                            <div class="relative z-20">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Yazarlar</label>
                                <div id="authorTagsContainer" class="flex flex-wrap gap-2 p-2 rounded-xl border border-slate-200 min-h-[45px] bg-white">
                                    <input type="text" id="authorSearchInput" placeholder="Yazar ara veya seç..." class="bg-transparent outline-none flex-grow min-w-[120px] px-2 text-sm">
                                </div>
                                <input type="hidden" name="authorIds" id="hiddenAuthorIds">
                                <div id="authorDropdownList" class="hidden absolute w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50 custom-scrollbar"></div>
                            </div>

                            <div class="relative z-10">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Kategoriler</label>
                                <div id="categoryTagsContainer" class="flex flex-wrap gap-2 p-2 rounded-xl border border-slate-200 min-h-[45px] bg-white">
                                    <input type="text" id="categorySearchInput" placeholder="Kategori ara veya seç..." class="bg-transparent outline-none flex-grow min-w-[120px] px-2 text-sm">
                                </div>
                                <input type="hidden" name="categoryIds" id="hiddenCategoryIds">
                                <div id="categoryDropdownList" class="hidden absolute w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-48 overflow-y-auto z-50 custom-scrollbar"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Açıklama</label>
                                <textarea name="description" rows="2" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 outline-none resize-none"></textarea>
                            </div>
                        </form>
                    </div>

                    <div class="px-8 py-6 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                        <button type="button" class="closeModalBtn px-6 py-2.5 rounded-xl text-slate-600 hover:bg-slate-200 font-medium">İptal</button>
                        <button type="submit" form="addBookForm" id="saveBookBtn" class="px-8 py-2.5 rounded-xl bg-blue-600 text-white hover:bg-blue-700 shadow-lg font-medium">Kaydet</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addAuthorModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm opacity-0 modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 opacity-0 flex flex-col modal-panel">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                    <h3 class="text-lg font-bold text-slate-800">Sisteme Yazar Ekle</h3>
                    <button class="closeAuthorModalBtn text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
                <div class="p-6">
                    <form id="addAuthorForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Yazar Adı Soyadı</label>
                            <input type="text" name="name" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-blue-500 outline-none" placeholder="Örn: Zülfü Livaneli">
                        </div>
                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" class="closeAuthorModalBtn px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100 text-sm font-bold">İptal</button>
                            <button type="submit" class="px-6 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm font-bold shadow-lg">Ekle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="addCategoryModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm opacity-0 modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform scale-95 opacity-0 flex flex-col modal-panel">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                    <h3 class="text-lg font-bold text-slate-800">Sisteme Kategori Ekle</h3>
                    <button class="closeCategoryModalBtn text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-lg"></i></button>
                </div>
                <div class="p-6">
                    <form id="addCategoryForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Kategori Adı</label>
                            <input type="text" name="name" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-blue-500 outline-none" placeholder="Örn: Bilim Kurgu">
                        </div>
                        <div class="flex justify-end gap-2 pt-2">
                            <button type="button" class="closeCategoryModalBtn px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100 text-sm font-bold">İptal</button>
                            <button type="submit" class="px-6 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 text-sm font-bold shadow-lg">Ekle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="drawerBackdrop" 
     onclick="closeDrawer()"
     class="fixed inset-0 z-[60] bg-slate-900/30 backdrop-blur-sm hidden transition-opacity duration-300 opacity-0">
</div>

<div id="drawerBackdrop" 
     onclick="closeDrawer()"
     class="fixed inset-0 z-[60] bg-slate-900/30 backdrop-blur-sm hidden transition-opacity duration-300 opacity-0">
</div>

<div id="drawerBackdrop" 
     onclick="closeDrawer()"
     class="fixed inset-0 z-[60] bg-slate-900/40 backdrop-blur-sm hidden transition-opacity duration-300 opacity-0">
</div>

<div id="bookDrawer" 
     class="fixed top-0 left-0 z-[70] h-full w-full max-w-[450px] bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col font-sans">
    
    <div class="px-6 py-4 border-b border-slate-50 flex justify-between items-center bg-white shrink-0">
        <h3 class="font-black text-slate-800 text-lg tracking-tight">Kitap Detayı</h3>
        <button onclick="closeDrawer()" class="w-9 h-9 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-rose-600 transition">
            <i class="fa-solid fa-xmark text-lg"></i>
        </button>
    </div>

    <div class="flex-grow flex flex-col min-h-0 overflow-hidden">
        
        <div class="p-6 bg-slate-50/50 flex gap-5 shrink-0 border-b border-slate-100">
            <div class="w-28 shrink-0 flex flex-col gap-2">
                <img id="drawerImage" src="" class="w-full aspect-[2/3] object-cover rounded-lg shadow-md bg-white" alt="Kapak">
                <div id="drawerStockBadge" class="text-[10px] text-center font-bold py-1.5 px-2 rounded-lg shadow-sm"></div>
            </div>

            <div class="flex-grow min-w-0 pt-1">
                <h2 id="drawerTitle" class="text-xl font-black text-slate-800 leading-tight mb-2 line-clamp-3"></h2>
                
                <div class="flex items-center gap-2 text-slate-500 text-sm font-medium mb-3">
                    <i class="fa-solid fa-feather-pointed text-blue-500 text-xs"></i>
                    <span id="drawerAuthor" class="truncate"></span>
                </div>

                <div id="drawerCategories" class="flex flex-wrap gap-1.5 mb-4"></div>

                <div class="flex items-center gap-2 text-[11px] text-slate-400 font-mono bg-white px-2 py-1 rounded border border-slate-100 inline-flex shadow-sm">
                    <i class="fa-solid fa-barcode"></i>
                    <span id="drawerIsbn"></span>
                </div>
            </div>
        </div>

        <div class="flex-grow overflow-y-auto custom-scrollbar p-6 bg-white">
            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-2">
                <i class="fa-solid fa-align-left"></i> Kitap Hakkında
            </h4>
            <p id="drawerDesc" class="text-slate-600 text-sm leading-7 text-justify whitespace-pre-line"></p>
        </div>
    </div>

    <div class="p-5 border-t border-slate-100 bg-white shrink-0" id="drawerFooter">
    </div>
</div>

    <div id="toastContainer" class="fixed top-5 right-5 z-[70] flex flex-col gap-2"></div>

    <script src="./assets/js/google-books.js" type="module"></script>
    <script type="module">
        import { loadNavbar, showToast } from './assets/js/layout.js';
        import { getAllBooks, deleteBook, getAuthors, getCategories, createBook, getBookById, updateBook } from './assets/js/book.js';
        import { borrowBook } from './assets/js/borrowing.js';
        import { fetchBookDetails } from './assets/js/google-books.js';
        import { request } from './assets/js/api.js';

        let editingBookId = null;
        let currentUser = null;
        
        // KRİTİK: Ham veri ve Filtrelenmiş veri ayrı tutulmalı
        let allBooks = []; 
        let filteredBooks = []; 

        const itemsPerPage = 12;
        let currentPage = 1;

        const cache = { authors: [], categories: [] };

        // XSS Koruması için yardımcı fonksiyon (Güvenlikçi adam bunu atlamaz!)
        function escapeHtml(unsafe) {
            if (!unsafe) return "";
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- ARAMA MANTIĞI BURADA ---
        document.getElementById('globalSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            
            if (!term) {
                filteredBooks = [...allBooks]; // Arama yoksa hepsini göster
            } else {
                filteredBooks = allBooks.filter(book => {
                    const titleMatch = (book.title || "").toLowerCase().includes(term);
                    const isbnMatch = (book.isbn || "").includes(term);
                    const authorMatch = book.authors && book.authors.some(a => a.name.toLowerCase().includes(term));
                    const catMatch = book.categories && book.categories.some(c => c.name.toLowerCase().includes(term));
                    
                    return titleMatch || isbnMatch || authorMatch || catMatch;
                });
            }
            
            currentPage = 1; // Filtre değişince sayfa 1'e dön
            renderLocalPage(1);
        });
        // -----------------------------

        // Modal ve Select logicleri aynen kalıyor (kısalttım, yer kaplamasın diye)
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            const backdrop = modal.querySelector('.modal-backdrop');
            const panel = modal.querySelector('.modal-panel');
            if (show) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.replace('opacity-0', 'opacity-100');
                    panel.classList.replace('opacity-0', 'opacity-100');
                    panel.classList.remove('scale-95');
                }, 10);
            } else {
                backdrop.classList.replace('opacity-100', 'opacity-0');
                panel.classList.replace('opacity-100', 'opacity-0');
                panel.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function setupPaginatedSelect(type, config) {
    const { searchId, dropdownId, containerId, hiddenId } = config;
    const searchInput = document.getElementById(searchId);
    const dropdown = document.getElementById(dropdownId);
    const tagsContainer = document.getElementById(containerId);
    const hiddenInput = document.getElementById(hiddenId);
    
    let selectedIds = [];
    let pagedCount = 0;
    const pageSize = 20;
    let currentFilter = "";

    // ... (renderItems ve updateHidden fonksiyonların aynen kalsın) ...
    // KOD TEKRARI OLMASIN DİYE KISALTTIM, MEVCUT renderItems KODUNU KORU
    const updateHidden = () => { hiddenInput.value = JSON.stringify(selectedIds); };

    const selectItem = (item) => {
        // Zaten seçiliyse ekleme
        if(selectedIds.includes(item.id)) return;
        
        selectedIds.push(item.id);
        updateHidden();
        
        const tag = document.createElement('div');
        tag.className = 'tag-badge bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 animate-fade-up';
        tag.innerHTML = `<span>${escapeHtml(item.name)}</span><button type="button" class="hover:text-red-500 transition"><i class="fa-solid fa-xmark"></i></button>`;
        
        tag.querySelector('button').onclick = () => { 
            selectedIds = selectedIds.filter(id => id !== item.id); 
            tag.remove(); 
            updateHidden(); 
        };
        
        tagsContainer.insertBefore(tag, searchInput);
        searchInput.value = ''; 
        currentFilter = ''; 
        dropdown.classList.add('hidden');
    };

    // --- YENİ EKLENEN KISIM: Enter tuşu ile kayıt ---
    searchInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // Form submit olmasın
            const val = searchInput.value.trim();
            if(!val) return;

            // Inputu kilitle, işlem yapıldığını göster
            const originalPlaceHolder = searchInput.placeholder;
            searchInput.placeholder = "Kaydediliyor...";
            searchInput.disabled = true;

            try {
                // Find or Create mantığı çalışır
                const item = await findOrCreateItem(type, val);
                if (item) {
                    selectItem(item);
                    showToast(`${val} başarıyla eklendi/seçildi.`, 'success');
                } else {
                    showToast("Kayıt sırasında hata oluştu.", 'error');
                }
            } finally {
                searchInput.disabled = false;
                searchInput.placeholder = originalPlaceHolder;
                searchInput.focus();
            }
        }
    });
    // ------------------------------------------------

    // ... (Diğer event listener'ların aynen kalsın: onfocus, oninput, onscroll, document click) ...
    // MEVCUT KODLARI KORU

    const renderItems = (isNewSearch = false) => {
        if (isNewSearch) { dropdown.innerHTML = ''; pagedCount = 0; }
        // Eğer cache boşsa veya filtreye uyan yoksa
        const filtered = cache[type].filter(item => item.name.toLowerCase().includes(currentFilter.toLowerCase()) && !selectedIds.includes(item.id));
        
        if (filtered.length === 0 && currentFilter.length > 0) {
            dropdown.innerHTML = `<div class="p-3 text-sm text-slate-500 italic text-center">
                                    "${escapeHtml(currentFilter)}" bulunamadı.<br>
                                    <span class="text-xs text-blue-600 font-bold">Eklemek için ENTER'a bas.</span>
                                  </div>`;
            return;
        }
        
        // ... (Sayfalama mantığın aynen kalsın) ...
        const itemsToRender = filtered.slice(pagedCount, pagedCount + pageSize);
        itemsToRender.forEach(item => {
            const div = document.createElement('div');
            div.className = 'dropdown-item p-3 hover:bg-blue-50 cursor-pointer text-sm text-slate-700 border-b border-slate-100 last:border-0';
            div.textContent = item.name;
            div.onclick = () => selectItem(item);
            dropdown.appendChild(div);
        });
        pagedCount += itemsToRender.length;
    };
    
    // Buradaki event listenerları tekrar bağlamayı unutma (kodun orijinalinde vardı)
    searchInput.onfocus = () => { dropdown.classList.remove('hidden'); renderItems(true); };
    searchInput.oninput = (e) => { currentFilter = e.target.value; renderItems(true); };
    // ... vb.

    return { 
        reset: () => { 
            selectedIds = []; 
            updateHidden(); 
            tagsContainer.querySelectorAll('.tag-badge').forEach(t => t.remove()); 
        }, 
        selectExternal: (item) => selectItem(item) 
    };
}

        const authorSelectControl = setupPaginatedSelect('authors', { searchId: 'authorSearchInput', dropdownId: 'authorDropdownList', containerId: 'authorTagsContainer', hiddenId: 'hiddenAuthorIds' });
        const categorySelectControl = setupPaginatedSelect('categories', { searchId: 'categorySearchInput', dropdownId: 'categoryDropdownList', containerId: 'categoryTagsContainer', hiddenId: 'hiddenCategoryIds' });

        // Yardımcı Fonksiyon: Cache'te varsa getir, yoksa veritabanında oluşturup cache'e ekle
async function findOrCreateItem(type, name) {
    if (!name) return null;
    const cleanName = name.trim();
    
    // 1. Önce Cache'e bak (Case-insensitive)
    const existing = cache[type].find(item => item.name.toLowerCase() === cleanName.toLowerCase());
    if (existing) return existing;

    // 2. Yoksa Backend'e istek atıp oluştur
    try {
        const endpoint = type === 'authors' ? '/authors' : '/categories';
        // Backend DTO: { name: "..." } bekliyor
        const newItem = await request(endpoint, 'POST', { name: cleanName });
        
        // 3. Cache'e ekle ki bir sonraki aramada bulunsun
        cache[type].push(newItem);
        return newItem;
    } catch (error) {
        console.error(`${type} oluşturulamadı:`, error);
        // Hata durumunda null dön, akışı bozma ama kullanıcıya bildirilebilir
        return null;
    }
}
        
        async function init() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                currentUser = await loadNavbar();
                if (currentUser?.role === 'ADMIN') document.getElementById('adminButtonParams').classList.remove('hidden');

                setupBookModalLogic(authorSelectControl, categorySelectControl);
                setupExtraModals(); // Yazar/Kategori ekleme modalları

                const [authors, categories] = await Promise.all([getAuthors(), getCategories()]);
                cache.authors = authors; cache.categories = categories;

                await refreshData();
            } catch (e) { 
                console.error("Init Error:", e);
                showToast("Hata: " + e.message, "error"); 
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // setupBookModalLogic ve setupExtraModals fonksiyonlarını senin kodundan aynen koru...
        function setupBookModalLogic(authorSelectControl, categorySelectControl) {
             const modalId = 'addBookModal';
             const form = document.getElementById('addBookForm');
             const saveBtn = document.getElementById('saveBookBtn'); // ID ile kesin seçim

             // 1. Ortak Temizlik Fonksiyonu
             const resetForm = () => {
                 form.reset(); 
                 authorSelectControl.reset(); 
                 categorySelectControl.reset(); 
                 
                 editingBookId = null; 
                 
                 document.getElementById('coverImage').src = "";
                 document.getElementById('coverImage').classList.add('hidden'); 
                 document.getElementById('coverPreview').classList.remove('hidden');
                 document.getElementById('imageUrlInput').value = ""; 
                 
                 // Buton metnini güvenli şekilde resetle
                 if(saveBtn) {
                     saveBtn.textContent = "Kaydet";
                     saveBtn.disabled = false;
                 }
             };

             // Modal Açılış
             document.getElementById('addBookBtn').onclick = () => {
                resetForm();
                document.querySelector('#addBookModal h3').textContent = "Yeni Kitap Kaydı";
                toggleModal(modalId, true);
            };

            // Modal Kapanış
            document.querySelectorAll('.closeModalBtn').forEach(btn => btn.onclick = () => {
                toggleModal(modalId, false);
                setTimeout(resetForm, 300);
            });

            // Form Submit Eventi
            form.onsubmit = async (e) => {
                e.preventDefault(); // Sayfa yenilenmesini engelle
                console.log("Form submit tetiklendi! İşlem başlıyor..."); // LOG 1

                // Buton kontrolü
                if (!saveBtn) {
                    console.error("HATA: saveBookBtn bulunamadı!");
                    showToast("Sistem hatası: Buton bulunamadı.", "error");
                    return;
                }

                // Butonu kilitle
                const oldText = saveBtn.textContent;
                saveBtn.disabled = true;
                saveBtn.textContent = "İşleniyor...";

                try {
                    // Verileri topla
                    const data = Object.fromEntries(new FormData(form));
                    data.authorIds = JSON.parse(document.getElementById('hiddenAuthorIds').value || "[]");
                    data.categoryIds = JSON.parse(document.getElementById('hiddenCategoryIds').value || "[]");
                    data.stock = parseInt(data.stock);

                    console.log("Gönderilecek Veri:", data); // LOG 2

                    let success = false;
                    if (editingBookId) {
                        await updateBook(editingBookId, data);
                        showToast("Kitap başarıyla güncellendi", "success");
                        success = true;
                    } else {
                        success = await createBook(data);
                        if(success) showToast("Kitap başarıyla eklendi", "success");
                    }
                    
                    if (success) { 
                        toggleModal('addBookModal', false); 
                        refreshData();
                        setTimeout(resetForm, 300); 
                    }
                } catch (error) { 
                    console.error("İşlem Hatası:", error); // LOG 3
                    showToast(error.message || "Bir hata oluştu", "error"); 
                } finally {
                    // Butonu her durumda eski haline getir
                    saveBtn.disabled = false;
                    saveBtn.textContent = editingBookId ? "Güncelle" : "Kaydet";
                }
            };
        }

        function setupExtraModals() {

            // ISBN ile Kitap Getir Butonu
            // ISBN ile Kitap Getir Butonu
            document.getElementById('fetchCoverBtn').onclick = async () => {
                const isbnInput = document.getElementById('isbnInput');
                // EKSİK OLAN SATIR BU:
                const form = document.getElementById('addBookForm'); 
                
                const isbn = isbnInput.value.trim();
                const btn = document.getElementById('fetchCoverBtn');

                if (!isbn) {
                    showToast("Lütfen bir ISBN giriniz", "error");
                    return;
                }
                
                // ... kodun geri kalanı aynen devam ediyor ...

                // Butonu kilitle
                const originalText = btn.textContent;
                btn.textContent = "Aranıyor...";
                btn.disabled = true;

                try {
                    // google-books.js modülündeki fonksiyonu çağır
                    const book = await fetchBookDetails(isbn);

                    if (book) {
                        // 1. Basit Alanları Doldur
                        form.querySelector('[name=title]').value = book.title || "";
                        form.querySelector('[name=description]').value = book.description || "";
                        form.querySelector('[name=imageUrl]').value = book.image || "";

                        // 2. Kapak Resmi Önizlemesi
                        if (book.image) {
                            document.getElementById('coverImage').src = book.image;
                            document.getElementById('coverImage').classList.remove('hidden');
                            document.getElementById('coverPreview').classList.add('hidden');
                        }

                        // 3. Yazarları Ekle (Backend'de yoksa oluşturur)
                        authorSelectControl.reset(); // Önce temizle
                        if (book.authors && book.authors.length > 0) {
                            for (const authorName of book.authors) {
                                // findOrCreateItem fonksiyonunu kullan (dashboard.html içinde tanımlı)
                                const item = await findOrCreateItem('authors', authorName);
                                if (item) authorSelectControl.selectExternal(item);
                            }
                        }

                        // 4. Kategorileri Ekle
                        categorySelectControl.reset();
                        if (book.categories && book.categories.length > 0) {
                            for (const catName of book.categories) {
                                const item = await findOrCreateItem('categories', catName);
                                if (item) categorySelectControl.selectExternal(item);
                            }
                        }

                        showToast("Kitap bilgileri başarıyla çekildi", "success");
                    } else {
                        showToast("Bu ISBN ile kayıt bulunamadı", "error");
                    }
                } catch (error) {
                    console.error("Fetch Error:", error);
                    showToast("Google API bağlantısında hata oluştu", "error");
                } finally {
                    // Butonu eski haline getir
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            };
            // ... (Senin kodundaki Yazar/Kategori ekleme modal logicleri buraya) ...
            // Bu kısımda bir sorun yoktu.
            const authorModalId = 'addAuthorModal';
            const authorForm = document.getElementById('addAuthorForm');

            document.getElementById('addAuthorBtn').onclick = () => toggleModal(authorModalId, true);
            document.querySelectorAll('.closeAuthorModalBtn').forEach(btn => btn.onclick = () => toggleModal(authorModalId, false));
            authorForm.onsubmit = async (e) => {
                e.preventDefault();
                try {
                    const newAuthor = await request('/authors', 'POST', Object.fromEntries(new FormData(authorForm)));
                    cache.authors.push(newAuthor);
                    toggleModal(authorModalId, false); authorForm.reset(); showToast("Yazar eklendi", "success");
                } catch(err) { showToast(err.message, "error"); }
            };
             // Kategori için de aynısı...
             const categoryModalId = 'addCategoryModal';
             const categoryForm = document.getElementById('addCategoryForm');
             document.getElementById('addCategoryBtn').onclick = () => toggleModal(categoryModalId, true);
             document.querySelectorAll('.closeCategoryModalBtn').forEach(btn => btn.onclick = () => toggleModal(categoryModalId, false));
             categoryForm.onsubmit = async (e) => {
                e.preventDefault();
                try {
                    const newCat = await request('/categories', 'POST', Object.fromEntries(new FormData(categoryForm)));
                    cache.categories.push(newCat);
                    toggleModal(categoryModalId, false); categoryForm.reset(); showToast("Kategori eklendi", "success");
                } catch(err) { showToast(err.message, "error"); }
            };
        }

        async function refreshData() {
            allBooks = await getAllBooks();
            // Veriyi çektikten sonra filtre listesini de güncelle
            filteredBooks = [...allBooks]; 
            
            // Eğer arama kutusunda bir şey varsa, tekrar filtrele (Sayfa yenilenince arama kaybolmasın istersen)
            const term = document.getElementById('globalSearch').value.toLowerCase().trim();
            if(term) {
                 filteredBooks = allBooks.filter(book => 
                    (book.title || "").toLowerCase().includes(term) || 
                    (book.isbn || "").includes(term)
                );
            }
            
            renderLocalPage(1);
        }

    // dashboard.html <script> içindeki renderLocalPage fonksiyonunu komple bununla değiştir:

function renderLocalPage(page) {
    currentPage = page;
    const start = (page - 1) * itemsPerPage;
    const paged = filteredBooks.slice(start, start + itemsPerPage);
    const grid = document.getElementById('bookGrid');
    
    if (filteredBooks.length === 0) {
        document.getElementById('emptyMessage').classList.remove('hidden');
        grid.classList.add('hidden');
        document.getElementById('pagination').classList.add('hidden');
        return;
    }

    document.getElementById('emptyMessage').classList.add('hidden');
    grid.classList.remove('hidden');
    
    grid.innerHTML = paged.map(book => {
        return `
        <div onclick="window.openBookDetail('${book.id}')" 
             class="bg-white rounded-2xl shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col h-full animate-fade-up cursor-pointer group select-none overflow-hidden relative">
            
            <div class="relative aspect-[2/3] bg-slate-100 overflow-hidden">
                <img src="${book.imageUrl || './assets/js/library-bg.jpg'}" class="w-full h-full object-cover transition duration-700 group-hover:scale-105">
                
                <div class="absolute top-3 right-3">
                    <span class="${book.stock > 0 ? 'bg-white/90 text-emerald-600' : 'bg-white/90 text-rose-600'} text-[10px] font-black px-2.5 py-1.5 rounded-lg shadow-sm backdrop-blur-sm">
                        ${book.stock > 0 ? book.stock + ' ADET' : 'TÜKENDİ'}
                    </span>
                </div>
            </div>

            <div class="p-5 flex flex-col flex-grow">
                <h3 class="font-bold text-slate-800 text-sm line-clamp-2 mb-1 leading-snug group-hover:text-blue-600 transition-colors" title="${escapeHtml(book.title)}">
                    ${escapeHtml(book.title)}
                </h3>
                <p class="text-[11px] text-slate-400 font-medium mb-4 flex items-center gap-1.5">
                    <i class="fa-solid fa-pen-nib text-[10px]"></i>
                    ${book.authors?.map(a => escapeHtml(a.name)).join(', ') || 'Bilinmiyor'}
                </p>
                
                <div class="mt-auto pt-2 flex items-center gap-2">
                    ${currentUser?.role === 'ADMIN' ? 
                        `<div class="flex justify-end gap-2 w-full">
                             <button onclick="event.stopPropagation(); window.handleEdit('${book.id}')" class="h-10 w-10 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-blue-600 hover:text-white transition shadow-sm hover:shadow-md" title="Düzenle">
                               <i class="fa-solid fa-pen-to-square"></i>
                             </button>
                             <button onclick="event.stopPropagation(); window.handleDelete('${book.id}')" class="h-10 w-10 flex items-center justify-center rounded-xl bg-slate-50 text-slate-400 hover:bg-rose-600 hover:text-white transition shadow-sm hover:shadow-md" title="Sil">
                              <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>`
                        : 
                        `<button onclick="event.stopPropagation(); window.handleBorrow('${book.id}')" 
                                ${book.stock <= 0 ? 'disabled' : ''} 
                                class="w-full h-10 bg-blue-600 text-white text-xs font-bold rounded-xl hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-blue-200 hover:shadow-lg flex items-center justify-center gap-2 transform active:scale-95">
                            ${book.stock > 0 ? 'Ödünç Al' : 'Stok Tükendi'}
                        </button>`
                    }
                </div>
            </div>
        </div>`;
    }).join('');
    
    renderPagination();
}

// Pagination fonksiyonunu da sadeleştir (Ring kalktı)
function renderPagination() {
    const total = Math.ceil(filteredBooks.length / itemsPerPage);
    const cont = document.getElementById('pagination');
    cont.innerHTML = '';
    
    if (total <= 1) {
        cont.classList.add('hidden');
        return;
    }
    cont.classList.remove('hidden');
    
    for (let i = 1; i <= total; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        // Ring-1 ve border-slate-200 kalktı. Sadece shadow.
        btn.className = `w-10 h-10 flex items-center justify-center rounded-xl font-bold text-xs transition-all duration-300 ${i === currentPage 
            ? 'bg-blue-600 text-white shadow-lg shadow-blue-200 scale-110' 
            : 'bg-white text-slate-500 shadow-sm hover:shadow-md hover:text-blue-600'}`; 
        btn.onclick = () => { renderLocalPage(i); window.scrollTo({ top: 0, behavior: 'smooth' }); };
        cont.appendChild(btn);
    }
}

        window.handleEdit = async (id) => {
             // ... (Senin handleEdit kodun aynen kalsın) ...
             // Sadece escapeHtml'e gerek yok çünkü inputlara value olarak basıyoruz, innerHTML değil.
             try {
                const book = await getBookById(id);
                if (!book) return showToast("Kitap bulunamadı", "error");
                editingBookId = id;
                document.querySelector('#addBookModal h3').textContent = "Kitap Düzenle";
                document.querySelector('button[form="addBookForm"]').textContent = "Güncelle";
                
                const form = document.getElementById('addBookForm');
                form.querySelector('[name=isbn]').value = book.isbn ?? "";
                form.querySelector('[name=title]').value = book.title ?? "";
                form.querySelector('[name=stock]').value = book.stock ?? 1;
                form.querySelector('[name=description]').value = book.description || "";
                form.querySelector('[name=imageUrl]').value = book.imageUrl || "";
                
                if (book.imageUrl) {
                    document.getElementById('coverImage').src = book.imageUrl;
                    document.getElementById('coverImage').classList.remove('hidden');
                    document.getElementById('coverPreview').classList.add('hidden');
                } else {
                    document.getElementById('coverImage').classList.add('hidden');
                    document.getElementById('coverPreview').classList.remove('hidden');
                }
                
                authorSelectControl.reset(); categorySelectControl.reset();
                (book.authors || []).forEach(a => authorSelectControl.selectExternal(a));
                (book.categories || []).forEach(c => categorySelectControl.selectExternal(c));
                
                toggleModal('addBookModal', true);
            } catch (err) { showToast(err.message, "error"); }
        };
        
        window.handleDelete = async (id) => { if(confirm("Silmek istediğine emin misin?")) { if(await deleteBook(id)) { showToast("Silindi", "success"); refreshData(); } } };
        window.handleBorrow = async (id) => { if(await borrowBook(id)) refreshData(); };

        init();
        // Yan Paneli Açan Fonksiyon
window.openBookDetail = (id) => {
    // 1. Kitabı bul (Hafızadaki listeden)
    const book = allBooks.find(b => b.id === id);
    if (!book) return; // Kitap yoksa işlem yapma

    const drawer = document.getElementById('bookDrawer');
    const backdrop = document.getElementById('drawerBackdrop');
    
    // 2. İçeriği Doldur
    document.getElementById('drawerTitle').innerText = book.title;
    document.getElementById('drawerAuthor').innerText = book.authors?.map(a => a.name).join(', ') || 'Yazar Bilinmiyor';
    document.getElementById('drawerIsbn').innerText = book.isbn;
    
    // Açıklama kontrolü
    const descText = book.description ? book.description : "Bu kitap için henüz detaylı bir açıklama girilmemiş.";
    document.getElementById('drawerDesc').innerText = descText;

    // Resim
    document.getElementById('drawerImage').src = book.imageUrl || './assets/js/library-bg.jpg';

    // Stok Rozeti
    const badge = document.getElementById('drawerStockBadge');
    if (book.stock > 0) {
        badge.className = "text-[10px] text-center font-black py-1 px-2.5 rounded shadow-sm bg-emerald-100 text-emerald-700 border border-emerald-200";
        badge.innerText = `STOK: ${book.stock}`;
    } else {
        badge.className = "text-[10px] text-center font-black py-1 px-2.5 rounded shadow-sm bg-rose-100 text-rose-700 border border-rose-200";
        badge.innerText = "TÜKENDİ";
    }

    // Kategoriler
    const catContainer = document.getElementById('drawerCategories');
    catContainer.innerHTML = book.categories?.map(c => 
        `<span class="px-2 py-0.5 bg-slate-100 text-slate-600 text-[10px] font-bold rounded border border-slate-200">${c.name}</span>`
    ).join('') || '';

    // 3. Footer Butonları (Role göre)
    const footer = document.getElementById('drawerFooter');
    if (currentUser.role === 'ADMIN') {
        footer.innerHTML = `
            <button onclick="closeDrawer(); window.handleEdit('${book.id}')" class="w-full h-12 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-900 transition flex items-center justify-center gap-2 shadow-lg hover:shadow-xl">
                <i class="fa-solid fa-pen-to-square"></i> Düzenle
            </button>
        `;
    } else {
        if (book.stock > 0) {
            footer.innerHTML = `
                <button onclick="closeDrawer(); window.handleBorrow('${book.id}')" class="w-full h-12 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 hover:shadow-blue-300 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-book-bookmark"></i> Kitabı Ödünç Al
                </button>
            `;
        } else {
            footer.innerHTML = `
                <button disabled class="w-full h-12 rounded-xl bg-slate-100 text-slate-400 font-bold cursor-not-allowed border border-slate-200 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-ban"></i> Stokta Yok
                </button>
            `;
        }
    }

    // 4. Animasyonlu Açılış (Soldan Sağa)
    backdrop.classList.remove('hidden');
    setTimeout(() => {
        backdrop.classList.remove('opacity-0');
        // Sol tarafta gizli olan paneli (-translate-x-full) sıfır noktasına çekiyoruz
        drawer.classList.remove('-translate-x-full'); 
    }, 10);
};

window.closeDrawer = () => {
    const drawer = document.getElementById('bookDrawer');
    const backdrop = document.getElementById('drawerBackdrop');

    // Sola geri it (-translate-x-full ekle)
    drawer.classList.add('-translate-x-full');
    backdrop.classList.add('opacity-0');

    setTimeout(() => {
        backdrop.classList.add('hidden');
    }, 300);
};
    </script>
</body>
</html>

